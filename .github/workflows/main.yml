name: Workflow buildpipeline 

on:
    push:
        branches:
            - main
jobs:
    #Build Job
    prepare:
        runs-on: ubuntu-latest
        steps:            
            - name: checkout
              uses: actions/checkout@v3

            - name: install node
              uses: actions/setup-node@v3
              with:
                node-version: 20.x

    install-frontend:
        runs-on: ubuntu-latest
        needs: prepare
        steps:
          - name: install dependencys
            run: |
              cd ./Workflow_testbed/frontend
              npm install
          - name: build frontend
            run: |
              cd frontend
              npm run build
          - name: upload-artifact
            uses: actions/upload-artifact@v3
            with:
              name: Build
              path: dist

    install-backend:
        runs-on: ubuntu-latest
        needs: install-frontend
        steps:
          - name: install dependencys
            run: |
              cd backend
              npm install
          - name: get dist
            uses: actions/download-artifact@v4
            with:
              name: upload-artifact
          - name: copy dist to the backend
            run: |
              cd backend
              cp -r dist ./
          - name: build backend
            run: |
              cd backend
              npm run build
          - name: upload-artifact
            uses: actions/upload-artifact@v3
            with:
              name: backend
              path: prod

    deploy:
      needs: install-backend
      runs-on: ubuntu-latest
      steps:
        - name: Download artifact
          uses: actions/download-artifact@v3
          with:
            name: backend
            path: prod

        - name: Deploy to GitHub Pages
          uses: peaceiris/actions-gh-pages@v3
          with:
            github_token: ${{ secrets.SECRET_KEY }}
            publish_dir: ./test/build

            