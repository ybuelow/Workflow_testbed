name: Workflow buildpipeline 

on:
    push:
        branches:
            - main
jobs:
    #Build Job
    prepare:
        runs-on: ubuntu-latest
        steps:            
            - name: checkout
              uses: actions/checkout@v3

            - name: install node
              uses: actions/setup-node@v3
              with:
                node-version: 20.x

    install-frontend:
        runs-on: ubuntu-latest
        needs: prepare
        steps:
          - name: checkout
            uses: actions/checkout@v3

          - name: install dependencys
            run: |
              cd ./frontend
              npm install
          - name: build frontend
            run: |
              cd frontend
              npm run build
              ls
          - name: upload-artifact
            uses: actions/upload-artifact@v4
            with:
              name: dist-folder
              path: ./frontend/dist

    install-backend:
        runs-on: ubuntu-latest
        needs: install-frontend
        steps:
          - name: checkout
            uses: actions/checkout@v3

          - name: install dependencys
            run: |
              cd backend
              npm install
              
          - name: get dist
            uses: actions/download-artifact@v4
            with:
              name: dist-folder
              path: ./frontend/dist

          - name: copy dist-folder to the backend
            run: |
              cd backend
              cp -r ../frontend/dist ./ 
              
          - name: upload-artifact
            uses: actions/upload-artifact@v4
            with:
              name: backend
              path: ./prod

    deploy:
      needs: install-backend
      runs-on: ubuntu-latest
      steps:
        - name: checkout
          uses: actions/checkout@v3

        - name: Download artifact
          uses: actions/download-artifact@v4
          with:
            name: backend
            path: ./prod

        - name: Deploy to GitHub Pages
          uses: peaceiris/actions-gh-pages@v3
          with:
            github_token: ${{ secrets.SECRET_KEY }}
            publish_dir: ./prod

            
